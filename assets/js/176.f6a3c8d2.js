(window.webpackJsonp=window.webpackJsonp||[]).push([[176],{545:function(e,a,t){"use strict";t.r(a);var r=t(42),s=Object(r.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"图片上传插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#图片上传插件"}},[e._v("#")]),e._v(" 图片上传插件")]),e._v(" "),t("h2",{attrs:{id:"carrierwave"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#carrierwave"}},[e._v("#")]),e._v(" CarrierWave")]),e._v(" "),t("ol",[t("li",[e._v("安装 Gem"),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("# 在 Gemfile中添加一行\ngem CarrierWave\n# 也许需要先安装本地套件\ngem Rmagick\n")])])])]),e._v(" "),t("li",[e._v("生成 Uploader"),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("# 在项目文件夹下运行命令\nrails g Uploader image\n")])])])]),e._v(" "),t("li",[e._v("View")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("<%= simple_form_for @user, :html => {:multipart => true}  do |f| %>\n    <%= f.file_format :photo, :label => 'Your avatar please' %>\n <% end %>\n")])])]),t("p",[e._v("Jcrop 使用参数")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$.Jcrop('#cropbox').setOptions({\n   aspectRatio: 4/3, // 设置比例\n   setSelect: [0, 0, 400, 300], // 默认大小\n   onSelect: fill, // 选择后事件\n   onChange: fill,\n   allowSelect: false //是否允许取消选框\n});\n\n")])])]),t("ol",{attrs:{start:"4"}},[t("li",[e._v("添加 Uploader 两种样式，并添加 :crop 预处理")]),e._v(" "),t("li",[e._v("控制器中判断是否第一次上传图片，渲染 crop.html.erb 页面")]),e._v(" "),t("li",[e._v("实现全屏预览剪裁")]),e._v(" "),t("li",[e._v("添加删除按钮")])]),e._v(" "),t("h2",{attrs:{id:"实践过程中遇到的几个坑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实践过程中遇到的几个坑"}},[e._v("#")]),e._v(" 实践过程中遇到的几个坑")]),e._v(" "),t("ol",[t("li",[e._v("安装 'rmagick' 插件报错")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("# 对于 Linux 系统\nsudo apt-get install imagemagick libmagickcore-dev libmagickwand-dev\n# Mac 系统\nbrew install imagemagick\n# 本地安装完成后，gem 'rmagick' 成功\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[t("p",[e._v("剪裁后，总看不到效果\n查看下 "),t("code",[e._v("Uploader")]),e._v(" 中设定的模板名称，调用结果的时候需要使用 image_url[:yourmode]")])]),e._v(" "),t("li",[t("p",[e._v("遇到 iphone 图片，竖版反转 90度的问题")])])]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://stackoverflow.com/questions/18519160/exif-image-rotation-issue-using-carrierwave-and-rmagick-to-upload-to-s3",target:"_blank",rel:"noopener noreferrer"}},[e._v("解决IPHONE竖版照片截取错误"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("核心代码是，'rmagick' 处理照片前，将其按照 exif 进行旋转")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v(" def auto_orient\n    manipulate! do |img|\n      img = img.auto_orient\n    end\n  end\n")])])]),t("p",[e._v("截图前都要调用")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("version :thumb do\n  process :auto_orient\n  process :crop\n  process :resize_to_fill => [400, 300]\nend\n")])])]),t("ol",{attrs:{start:"5"}},[t("li",[t("p",[e._v("如何在触屏上使用？\n请下载最新版 Jcrop")])]),e._v(" "),t("li",[t("p",[e._v("如何全屏截图，即将图片宽度等比放大，且保证截图精准，需要修改下源码，将 Jcrop 读取图片源码部分，改为返回图片样式尺寸")])])]),e._v(" "),t("p",[e._v("JS 写法请参考本案例 "),t("a",{attrs:{href:"https://github.com/boboidream/meetup/blob/master/app/views/user_galleries/crop.html.erb",target:"_blank",rel:"noopener noreferrer"}},[e._v("全屏截图"),t("OutboundLink")],1)]),e._v(" "),t("ol",{attrs:{start:"7"}},[t("li",[e._v("由于图片加载太快，获取不到图片实际尺寸，怎么办？\n为了这个问题，浪费了一下午，其实很简单，只需要等待图片加载完成再执行函数。")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$('#cropbox').bind('load', function() {\n    // ....\n    });\n")])])]),t("ol",{attrs:{start:"8"}},[t("li",[e._v("遇到 $.Jscrop is not a function\nJS 加载顺序问题，需要让 jq 与 Jcrop 比自己写的脚本提前加载，我遇到问题是项目 layout 所加载文件太多，解决方法 "),t("code",[e._v("layout: none")]),e._v(",只加载自己需要的几个插件")])]),e._v(" "),t("h2",{attrs:{id:"其他参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他参考资料"}},[e._v("#")]),e._v(" 其他参考资料")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://jcrop.org/demos/preview",target:"_blank",rel:"noopener noreferrer"}},[e._v("添加预览效果"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://solidfoundationwebdev.com/blog/posts/cannot-render-console-from-some-ip-with-rails",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cannot render console to 192.168.1.5"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://stackoverflow.com/questions/36034437/jcrop-incorrect-orientation-from-iphone-upload-how-i-can-do",target:"_blank",rel:"noopener noreferrer"}},[e._v("解决竖版照片思路"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://stackoverflow.com/questions/13648162/using-jcrop-on-responsive-images",target:"_blank",rel:"noopener noreferrer"}},[e._v("全屏剪裁"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=s.exports}}]);